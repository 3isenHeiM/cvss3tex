\usepackage{pgfmath}

% Equations from https://www.first.org/cvss/specification-document#i8
% Values from https://www.first.org/cvss/specification-document#i8.4

%1 Attack Vector
%Network N, Adjacent A, Local L, Physical P
\newcommand*{\AVNvalue}{0.85}
\newcommand*{\AVAvalue}{0.62}
\newcommand*{\AVLvalue}{0.55}
\newcommand*{\AVPvalue}{0.2}
\newcommand{\parseAttackVector}[1]{%
    \ifnum\pdfstrcmp{#1}{N}=0
    \AVNvalue% #1 = "N"
    \else\ifnum\pdfstrcmp{#1}{A}=0
    \AVAvalue%
    \else\ifnum\pdfstrcmp{#1}{L}=0
    \AVLvalue%
    \else\ifnum\pdfstrcmp{#1}{P}=0
    \AVPvalue%
    \else%
    InvalidAttackVector%
    \fi\fi\fi\fi%
}

%2 Attack Complexity
%Low L, High H
\newcommand*{\ACLvalue}{0.77}
\newcommand*{\ACHvalue}{0.44}
\newcommand{\parseAttackComplexity}[1]{%
    \ifnum\pdfstrcmp{#1}{L}=0
    \ACLvalue%
    \else\ifnum\pdfstrcmp{#1}{H}=0
    \ACHvalue%
    \else%
    InvalidAttackComplexity%
    \fi\fi%
}

%3 Privileges Required
%None N, Low L, High H
\newcommand*{\PRNvalue}{0.85}
\newcommand*{\PRLvalue}{0.62}
\newcommand*{\PRLSCvalue}{0.68}
\newcommand*{\PRHvalue}{0.27}
\newcommand*{\PRHSCvalue}{0.50}
\newcommand{\parsePrivilegesRequired}[2]{%
    % #1 = Privileges Required
    % #2 = Scope
    \ifnum\pdfstrcmp{#2}{U}=0
    \parsePrivilegesRequiredScopeUnchanged{#1}%
    \else\ifnum\pdfstrcmp{#2}{C}=0
    \parsePrivilegesRequiredScopeChanged{#1}%
    \else%
    InvalidPrivilegesRequired%
    \fi\fi%
}

\newcommand{\parsePrivilegesRequiredScopeUnchanged}[1]{%
    \ifnum\pdfstrcmp{#1}{N}=0
    \PRNvalue%
    \else\ifnum\pdfstrcmp{#1}{L}=0
    \PRLvalue%
    \else\ifnum\pdfstrcmp{#1}{H}=0
    \PRHvalue%
    \else%
    InvalidPrivilegesRequiredScopeUnchanged%
    \fi\fi\fi%
}

\newcommand{\parsePrivilegesRequiredScopeChanged}[1]{%
    \ifnum\pdfstrcmp{#1}{N}=0
    \PRNvalue%
    \else\ifnum\pdfstrcmp{#1}{L}=0
    \PRLSCvalue%
    \else\ifnum\pdfstrcmp{#1}{H}=0
    \PRHSCvalue%
    \else%
    InvalidPrivilegesRequiredScopeChanged%
    \fi\fi\fi%
}

%4 User Interaction
%None N, Required R
\newcommand*{\UINvalue}{0.85}
\newcommand*{\UIRvalue}{0.62}
\newcommand{\parseUserInteraction}[1]{%
    \ifnum\pdfstrcmp{#1}{N}=0
    \UINvalue%
    \else\ifnum\pdfstrcmp{#1}{R}=0
    \UIRvalue%
    \else%
    InvalidAttackVector%
    \fi\fi%
}

%5 Scope
%Unchanged U, Changed C
% (See parsePrivilegesRequired)

%6 Confidentiality Impact
%High H, Low L, None N
%7 Integrity Impact
%High H, Low L, None N
%8 Availability Impact
%High H, Low L, None N
\newcommand*{\CIAHvalue}{0.56}
\newcommand*{\CIALvalue}{0.22}
\newcommand*{\CIANvalue}{0.00}
\newcommand{\parseCIA}[1]{%
    \ifnum\pdfstrcmp{#1}{H}=0
    \CIAHvalue%
    \else\ifnum\pdfstrcmp{#1}{L}=0
    \CIALvalue%
    \else\ifnum\pdfstrcmp{#1}{N}=0
    \CIANvalue%
    \else%
    InvalidCIA%
    \fi\fi\fi%
}


\newcommand{\calcAndParseIscBase}[3]{%
    % #1 Confidentiality Impact %High H, Low L, None N
    % #2 Integrity Impact %High H, Low L, None N
    % #3 Availability Impact %High H, Low L, None N
    \pgfmathsetmacro\calcIscBaseResult{1 - ( (1 - (\parseCIA{#1})) * (1 - (\parseCIA{#2})) * (1 - (\parseCIA{#3})) ) }%
}

\newcommand{\calcIsc}[2]{%
    % #1 = Scope
    % #2 = ICSbase
    % Scope Unchanged 6.42 × ISCBase
    % Scope Changed 7.52 × [ISCBase−0.029] − 3.25 × [ISCBase−0.02]15
    \ifnum\pdfstrcmp{#1}{U}=0
    \pgfmathsetmacro\calcIscResult{ 6.42 * (#2) }%
    \else
    \ifnum\pdfstrcmp{#1}{C}=0
    \pgfmathsetmacro\calcIscResult{7.52 * ( (#2) - 0.029 ) - 3.25 * ( (#2) - 0.02 )^15}%
    \else%
    InvalidPrivilegesRequired%
    \fi%
    \fi%
}


\newcommand{\calcExploitability}[4]{%
    % #1 Attack Vector
    % #2 Attack Complexity
    % #3 Privileges Required
    % #4 User Interaction
    % 8.22 × AttackVector × AttackComplexity × PrivilegeRequired × UserInteraction
    \pgfmathsetmacro\calcExploitabilityResult{ 8.22 * (#1) * (#2) * (#3) * (#4) }%
}%

\newcommand{\calcAndParseExploitability}[5]{%
    % #1 Attack Vector
    % #2 Attack Complexity
    % #3 Privileges Required
    % #4 User Interaction
    % #5 Scope
    \calcExploitability%
    {\parseAttackVector{#1}}%
    {\parseAttackComplexity{#2}}%
    {\parsePrivilegesRequired{#3}{#5}}%
    {\parseUserInteraction{#4}}%
}

\newcommand{\calculateCVSSScopeUnchanged}[2]{%
    % #1 ISC
    % #2 Exploitability
    % Scope Unchanged[4] Round up (Minimum [(Impact + Exploitability),10])
    \pgfmathsetmacro\baseCVSSscore{\ceil{min((#1 + #2), 10)}}%
}

\newcommand{\calculateCVSSScopeChanged}[2]{%
    % #1 ISC
    % #2 Exploitability
    % Scope Changed Round up (Minumum [1.08 × (Impact + Exploitability),10])
    \pgfmathsetmacro\baseCVSSscore{\ceil{min( (1.08 * (#1 + #2)), 10) }}%
}


\ExplSyntaxOn
% https://tex.stackexchange.com/a/615358/28926
\NewExpandableDocumentCommand{\ceil}{m}
{
    \fp_eval:n { ceil(#1,1) }
    \fp_compare:nT { ceil(#1,1)=ceil(#1,0) } {.0}
}
\ExplSyntaxOff


\newcommand{\cvssBaseScore}[8]{%
    % #1 Attack Vector %Network N, Adjacent A, Local L, Physical P
    % #2 Attack Complexity %Low L, High H
    % #3 Privileges Required %None N, Low L, High H
    % #4 User Interaction %None N, Required R
    % #5 Scope %Unchanged U, Changed C
    % #6 Confidentiality Impact %High H, Low L, None N
    % #7 Integrity Impact %High H, Low L, None N
    % #8 Availability Impact %High H, Low L, None N
    %
    %\calcAndParseIscBase}[3]{
    % #1 Confidentiality Impact
    % #2 Integrity Impact
    % #3 Availability Impact
    \calcAndParseIscBase{#6}{#7}{#8}%
    %
    %\calcIsc}[2]{%
    % #1 = Scope
    % #2 = ICSbase
    \calcIsc{#5}{\calcIscBaseResult}%
    %
    %\calcAndParseExploitability}[5]{%
    % #1 Attack Vector
    % #2 Attack Complexity
    % #3 Privileges Required
    % #4 User Interaction
    % #5 Scope
    \calcAndParseExploitability{#1}{#2}{#3}{#4}{#5}%
    %
    % If (Impact sub score =< 0) 0 else,
    %
    \pgfmathparse{\calcIscResult <= 0 ? int(1) : int(0)}%
    \let\r\pgfmathresult%
    \ifnum\r>0%
    0%
    \else%
    \ifnum\pdfstrcmp{#5}{U}=0%
    \calculateCVSSScopeUnchanged{\calcIscResult}{\calcExploitabilityResult}%
    \baseCVSSscore%
    \else%
    \ifnum\pdfstrcmp{#5}{C}=0%
    \calculateCVSSScopeChanged{\calcIscResult}{\calcExploitabilityResult}%
    \baseCVSSscore%
    \else%
    InvalidScope%
    \fi%
    \fi%
    \fi%
}


\newcommand{\cvssBaseScorePretty}[8]{%
    \dumpSettingsShort{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
    ~~
    \formatDump{Score}{\cvssBaseScore{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}}
}

\newcommand{\cvssBaseScoreUsual}[8]{%
    \cvssBaseScore{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
    \quad CVSS:3.1/\dumpSettingsInline{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}%
}%

\newcommand{\cvssTest}{%
    %
    \testParsing%
    \testCalculations%
}

\newcommand{\testParsing}{%
    %
    %
    \parseAttackVector{N}

    \parseAttackVector{A}

    \parseAttackVector{L}

    \parseAttackVector{P}

    %
    \parseAttackComplexity{L}

    \parseAttackComplexity{H}

    %
    \parsePrivilegesRequired{N}{U}

    \parsePrivilegesRequired{L}{U}

    \parsePrivilegesRequired{H}{U}
    %
    \parsePrivilegesRequired{N}{C}

    \parsePrivilegesRequired{L}{C}
    %
    \parsePrivilegesRequired{H}{C}

    %
    \parseUserInteraction{N}

    \parseUserInteraction{R}

    %
    \parseCIA{H}

    \parseCIA{L}

    \parseCIA{N}

}


\newcommand{\testCalculations}{%
    \noindent%
    %
    Should be 0.6568:
    \calcAndParseIscBase{N}{L}{H}%
    \calcIscBaseResult \\%
    %
    Should be 64.2:
    \calcIsc{U}{10}%
    \calcIscResult \\%
    %
    Should be 4.9015704164:
    \calcIsc{C}{1}%
    \calcIscResult \\%
    %
    Should be 0.51375:
    \calcExploitability{0.5}{0.5}{0.5}{0.5}%
    \calcExploitabilityResult \\%
    %
    Should be 2.83525473:
    \calcAndParseExploitability{N}{L}{L}{N}{U}%
    \calcExploitabilityResult \\%
    %
    Should be 3.10963422:
    \calcAndParseExploitability{N}{L}{L}{N}{C}%
    \calcExploitabilityResult \\%
    %
    Should be 4.1:
    \ceil{4.02}\\%
    %
    Should be 4:
    \ceil{4.0}\\%
    %
    Should be 4:
    \ceil{3.91}\\%
    %
    Should be 2:
    \ceil{2}\\%
    %
    Should be 0.3:
    \ceil{0.24}\\%
    %
    Should be 0.3:
    \ceil{0.29}\\%
    %
    Should be -0.2:
    \ceil{-0.27}\\%
    %
    Should be -0.2:
    \ceil{-0.2}\\%
    %
    Should be 7.3:
    \cvssBaseScore{N}{L}{N}{N}{U}{L}{L}{L} \\%
    %
    Should be 8.3:
    \cvssBaseScore{N}{L}{N}{N}{C}{L}{L}{L}%
}

\newcommand{\parse}[8]{
    \parseAttackVector{#1}%
    \parseAttackComplexity{#2}%
    \parsePrivilegesRequired{#3}{#5}%
    \parseUserInteraction{#4}%
    \parseCIA{#6}%
    \parseCIA{#7}%
    \parseCIA{#8}%
}

\newcommand{\dumpSettings}[8]{%
    \noindent%
    \formatDump{Attack Vector}{#1}\\%
    \formatDump{Attack Complexity}{#2}\\%
    \formatDump{Privileges Required}{#3}\\%
    \formatDump{User Interaction}{#4}\\%
    \formatDump{Scope}{#5}\\%
    \formatDump{Confidentiality Impact}{#6}\\%
    \formatDump{Integrity Impact}{#7}\\%
    \formatDump{Availability Impact}{#8}\\%
}

\newcommand{\dumpSettingsShort}[8]{%
    \noindent%
    \formatDump{AV}{#1}%
    \formatDump{AC}{#2}%
    \formatDump{PR}{#3}%
    \formatDump{UI}{#4}%
    \formatDump{S}{#5}%
    \formatDump{C}{#6}%
    \formatDump{I}{#7}%
    \formatDump{A}{#8}%
}

\newcommand{\formatDump}[2]{%
    \textbf{#1:} #2\enskip%
}
